From 13376d2cdd92a0759da66ef8b329908a05f388c1 Mon Sep 17 00:00:00 2001
From: Eduardo Ferreira <eduardo.barbosa@toradex.com>
Date: Mon, 2 Dec 2024 18:05:51 +0000
Subject: [PATCH] ostree-fetcher-curl: set max parallel connections

Allow the maximum number of parallel downloads to
be set by an environment variable. The code was
heavily based on this pull request:
https://github.com/uptane/meta-updater/pull/29

Upstream-Status: Inappropriate [needs upstream discussion]

Signed-off-by: Lucas Morishita <lucas.morishita@toradex.com>
Signed-off-by: Jeremias Cordoba <jeremias.cordoba@toradex.com>
Signed-off-by: Eduardo Ferreira <eduardo.barbosa@toradex.com>
---
 src/libostree/ostree-fetcher-curl.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/libostree/ostree-fetcher-curl.c b/src/libostree/ostree-fetcher-curl.c
index aadf6f6..502c051 100644
--- a/src/libostree/ostree-fetcher-curl.c
+++ b/src/libostree/ostree-fetcher-curl.c
@@ -251,8 +251,14 @@ _ostree_fetcher_init (OstreeFetcher *self)
   rc = curl_multi_setopt (self->multi, CURLMOPT_TIMERDATA, self);
   g_assert_cmpint (rc, ==, CURLM_OK);
 #if CURL_AT_LEAST_VERSION(7, 30, 0)
+  long curlm_max_total_conn = 0L;
+  const char* curlm_max_total_conn_str = g_getenv ("OSTREE_CURLM_MAX_TOTAL_CONN");
+  if (curlm_max_total_conn_str != NULL)
+    curlm_max_total_conn = atoi(curlm_max_total_conn_str);
   /* Let's do something reasonable here. */
-  rc = curl_multi_setopt (self->multi, CURLMOPT_MAX_TOTAL_CONNECTIONS, 8);
+  if (curlm_max_total_conn == 0)
+    curlm_max_total_conn = 8;
+  rc = curl_multi_setopt (self->multi, CURLMOPT_MAX_TOTAL_CONNECTIONS, curlm_max_total_conn);
   g_assert_cmpint (rc, ==, CURLM_OK);
 #endif
   /* This version mirrors the version at which we're enabling HTTP2 support.
-- 
2.34.1

